<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Adaptive Equalizer</title>
  <link rel="preload" as="audio" href="/static/Soil Festivities.mp3">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
  <style>
    body { font-family: Arial, system-ui; max-width: 1100px; margin: 24px auto; padding: 0 12px; }
    .row { display:flex; gap:20px; margin:12px 0; flex-wrap:wrap; align-items:center; }
    label { font-size:12px; display:block; opacity:.9; }
    input[type=range]{ width:240px; }
    img { max-width:100%; border-radius:6px; display:block; }
    button{padding:8px 14px; cursor:pointer;}
    button[disabled]{ opacity:.6; cursor:not-allowed;}
    #msg{ color:#b00; margin:8px 0; min-height:1.2em; }
    .val { min-width: 42px; display:inline-block; text-align:right; }
    #progressWrap { display:none; align-items:center; gap:10px; }
    .spinner { width:16px; height:16px; border:2px solid #ccc; border-top-color:#333; border-radius:50%; animation:spin .8s linear infinite;}
    @keyframes spin { to{ transform:rotate(360deg)} }
    #modWrap{ border:1px solid #e5e5e5; border-radius:10px; padding:12px; }
    #curveArea{ display:flex; flex-direction:column; align-items:center; }
    #curveCanvas{ width: 900px; height: 240px; }
    #slidersRow{ display:flex; justify-content:space-between; width:900px; margin-top:14px; }
    .knobCol{ display:flex; flex-direction:column; align-items:center; user-select:none; }
    .knobCol input[type=range]{ writing-mode: bt-lr; -webkit-appearance: slider-vertical; height: 150px; width: 28px; }
    .knobLabel{ font-size:11px; margin-top:6px; }
    .grid2{ display:grid; grid-template-columns: repeat(2, 1fr); gap:16px; }
    .imgCard{ position:relative; border:1px solid #e5e5e5; border-radius:10px; padding:10px; }
    .imgTitle{ display:flex; align-items:center; gap:8px; margin-bottom:8px; }
    .overlayBox{ position:absolute; top:10px; right:10px; background:rgba(0,0,0,0.6); color:#fff; padding:6px 8px; font-size:12px; border-radius:6px; max-width:55%; line-height:1.25; display:none; }
    .hide { display:none !important; }
    .sectionTitle { font-weight: 700; margin-top: 8px; }
    #musicNote { font-size:12px; color:#666; }
  </style>
</head>
<body>
  <h2>Adaptive Equalizer</h2>

  <!-- ðŸŽµ Background music toggle -->
  <div class="row">
    <label><input type="checkbox" id="bgmToggle"> Enable background music</label>
    <span id="musicNote" class="hide">Autoplay was blocked â€” toggle to start.</span>
    <audio id="bgm" src="/static/Soil Festivities.mp3" loop preload="auto"></audio>
  </div>

  <!-- 1) Load image -->
  <div class="row">
    <div>
      <label>Upload image</label>
      <input type="file" id="fileInput" accept="image/*"/>
    </div>
  </div>

  <!-- 2) Controls - Modulation FIRST -->
  <div class="sectionTitle">Modulation</div>
  <div class="row">
    <label><input type="checkbox" id="enable_mod"/> enable modulation</label>
  </div>

  <div id="modWrap" class="hide">
    <div class="row" style="justify-content:space-between; align-items:center;">
      <strong>Band Modulation</strong>
      <div>
        <label>N knobs (3..10)</label>
        <input type="number" id="n_controls" min="3" max="10" step="1" value="5" style="width:64px;"/>
        <button id="applyKnobsBtn">Apply</button>
      </div>
    </div>

    <div id="curveArea">
      <canvas id="curveCanvas" width="900" height="240"></canvas>
      <div id="slidersRow"></div>
    </div>
  </div>

  <!-- Equalization SECOND -->
  <div class="sectionTitle">Equalization</div>
  <div class="row">
    <label><input type="checkbox" id="enable_eq"/> enable equalization</label>
  </div>

  <div id="eqWrap" class="hide">
    <div class="row">
      <div>
        <label>alpha: <span id="alpha_val" class="val">1.00</span></label>
        <input type="range" id="alpha" min="0" max="10" step="0.05" value="1"/>
      </div>
      <div>
        <label>gamma: <span id="gamma_val" class="val">1.20</span></label>
        <input type="range" id="gamma" min="0.5" max="3" step="0.05" value="1.2"/>
      </div>
    </div>
    <div class="row">
      <div>
        <label>band_sign</label>
        <select id="band_sign">
          <option value="dog" selected>dog</option>
          <option value="literal">literal</option>
        </select>
      </div>
      <label><input type="checkbox" id="preserve_mean" checked/> preserve mean</label>
    </div>
  </div>

  <!-- 3) Process -->
  <div class="row">
    <button id="processBtn" class="hide" disabled>Process</button>
    <a id="downloadLinkOut" style="display:none;margin-left:8px;">Download Output</a>
    <div id="progressWrap"><div class="spinner"></div><span id="progressText">Processingâ€¦</span></div>
  </div>

  <div id="msg"></div>

  <!-- Results -->
  <div class="grid2">
    <div class="imgCard hide" id="origCard">
      <div class="imgTitle"><strong>Original</strong></div>
      <img id="imgOriginal" alt="Original"/>
    </div>

    <div class="imgCard hide" id="outCard">
      <div class="imgTitle">
        <strong>Output</strong>
        <label><input type="checkbox" id="overlayOut" checked/> overlay parameters</label>
      </div>
      <div class="overlayBox" id="overlayBoxOut"></div>
      <img id="imgOutput" alt="Output"/>
    </div>
  </div>

  <!-- Main logic -->
  <script src="/static/script.js"></script>
</body>
</html>
